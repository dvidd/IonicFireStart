{"version":3,"file":"messaging.js","sourceRoot":"","sources":["../../../../src/messaging/messaging.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable, Inject, Optional, NgZone, PLATFORM_ID } from '@angular/core';\nimport { isPlatformBrowser } from '@angular/common';\nimport { messaging } from 'firebase/app';\nimport { Observable, empty, from, of, throwError } from 'rxjs';\nimport { mergeMap, catchError, map, switchMap, concat, defaultIfEmpty } from 'rxjs/operators';\nimport { FirebaseOptions, FirebaseAppConfig, runOutsideAngular } from '@angular/fire';\nimport { FirebaseOptionsToken, FirebaseNameOrConfigToken, _firebaseAppFactory, FirebaseZoneScheduler } from '@angular/fire';\n\n@Injectable()\nexport class AngularFireMessaging {\n  messaging: Observable<messaging.Messaging>;\n  requestPermission: Observable<void>;\n  getToken: Observable<string|null>;\n  tokenChanges: Observable<string|null>;\n  messages: Observable<{}>;\n  requestToken: Observable<string|null>;\n  deleteToken: (token: string) => Observable<boolean>;\n\n  constructor(\n    @Inject(FirebaseOptionsToken) options:FirebaseOptions,\n    @Optional() @Inject(FirebaseNameOrConfigToken) nameOrConfig:string|FirebaseAppConfig|undefined,\n    @Inject(PLATFORM_ID) platformId: Object,\n    zone: NgZone\n  ) {\n\n    if (isPlatformBrowser(platformId)) {\n\n      // @ts-ignore\n      const requireMessaging = from(import('firebase/messaging'));\n\n      this.messaging = requireMessaging.pipe(\n        map(() => _firebaseAppFactory(options, nameOrConfig)),\n        map(app => app.messaging()),\n        runOutsideAngular(zone)\n      );\n\n      this.requestPermission = this.messaging.pipe(\n        switchMap(messaging => messaging.requestPermission()),\n        runOutsideAngular(zone)\n      );\n\n    } else {\n\n      this.messaging = empty();\n      this.requestPermission = throwError('Not available on server platform.');\n\n    }\n\n    this.getToken = this.messaging.pipe(\n      switchMap(messaging => messaging.getToken()),\n      defaultIfEmpty(null),\n      runOutsideAngular(zone)\n    );\n\n    const tokenChanges = this.messaging.pipe(\n      switchMap(messaging => new Observable(messaging.onTokenRefresh.bind(messaging)).pipe(\n        switchMap(() => messaging.getToken())\n      )),\n      runOutsideAngular(zone)\n    );\n\n    this.tokenChanges = this.getToken.pipe(\n      concat(tokenChanges)\n    );\n\n    this.messages = this.messaging.pipe(\n      switchMap(messaging => new Observable(messaging.onMessage.bind(messaging))),\n      runOutsideAngular(zone)\n    );\n\n    this.requestToken = this.requestPermission.pipe(\n      catchError(() => of(null)),\n      mergeMap(() => this.tokenChanges)\n    );\n\n    this.deleteToken = (token: string) => this.messaging.pipe(\n      switchMap(messaging => messaging.deleteToken(token)),\n      defaultIfEmpty(false),\n      runOutsideAngular(zone)\n    );\n  }\n\n}\n"]}