{"version":3,"file":"changes.js","sourceRoot":"","sources":["../../../../src/firestore/collection/changes.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,iBAAiB,EAAE,MAAM,uBAAuB,CAAC;AAE1D,OAAO,oBAAoB,CAAC;AAE5B,OAAO,uBAAuB,CAAC;AAC/B,OAAO,0BAA0B,CAAC;AAClC,OAAO,wBAAwB,CAAC;AAShC,MAAM,qBAAqB,KAA+B;IACxD,MAAM,CAAC,iBAAiB,CAAC,KAAK,CAAC;SAC5B,GAAG,CAAC,UAAA,MAAM;QACT,OAAA,MAAM,CAAC,OAAO,CAAC,UAAU;aACtB,GAAG,CAAC,UAAA,MAAM,IAAI,OAAA,CAAC,EAAE,IAAI,EAAE,MAAM,CAAC,IAAI,EAAE,OAAO,EAAE,MAAM,EAAE,CAAC,EAAxC,CAAwC,CAAC;IAD1D,CAC0D,CAAC,CAAC;CACjE;AAMD,MAAM,wBAAwB,KAA+B,EAAE,MAA+C;IAC5G,MAAM,CAAC,iBAAiB,CAAC,KAAK,CAAC;SAC5B,GAAG,CAAC,UAAA,OAAO,IAAI,OAAA,OAAO,CAAC,OAAO,CAAC,UAAU,EAA1B,CAA0B,CAAC;SAC1C,IAAI,CAAC,UAAC,OAAO,EAAE,OAAO,IAAK,OAAA,cAAc,CAAC,OAAO,EAAE,OAAO,EAAE,MAAM,CAAC,EAAxC,CAAwC,EAAE,EAAE,CAAC;SACxE,GAAG,CAAC,UAAA,OAAO,IAAI,OAAA,OAAO,CAAC,GAAG,CAAC,UAAA,CAAC,IAAI,OAAA,CAAC,EAAE,IAAI,EAAE,CAAC,CAAC,IAAI,EAAE,OAAO,EAAE,CAAC,EAAE,CAAC,EAA9B,CAA8B,CAAC,EAAhD,CAAgD,CAAC,CAAC;CACrE;AASD,MAAM,yBAAyB,OAA4C,EAAE,OAA4C,EAAE,MAA+C;IACxK,OAAO,CAAC,OAAO,CAAC,UAAA,MAAM;QAEpB,EAAE,CAAA,CAAC,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;YACpC,OAAO,GAAG,aAAa,CAAC,OAAO,EAAE,MAAM,CAAC,CAAC;SAC1C;KACF,CAAC,CAAC;IACH,MAAM,CAAC,OAAO,CAAC;CAChB;AAOD,MAAM,wBAAwB,QAA6C,EAAE,MAAyC;IACpH,MAAM,CAAA,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC;QACnB,KAAK,OAAO;YACV,EAAE,CAAC,CAAC,QAAQ,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,QAAQ,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC,GAAG,CAAC,EAAE,IAAI,MAAM,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,CAAC;aAEpF;YAAC,IAAI,CAAC,CAAC;gBACN,QAAQ,CAAC,MAAM,CAAC,MAAM,CAAC,QAAQ,EAAE,CAAC,EAAE,MAAM,CAAC,CAAC;aAC7C;YACD,KAAK,CAAC;QACR,KAAK,UAAU;YAGb,EAAE,CAAA,CAAC,MAAM,CAAC,QAAQ,KAAK,MAAM,CAAC,QAAQ,CAAC,CAAC,CAAC;gBACvC,QAAQ,CAAC,MAAM,CAAC,MAAM,CAAC,QAAQ,EAAE,CAAC,CAAC,CAAC;gBACpC,QAAQ,CAAC,MAAM,CAAC,MAAM,CAAC,QAAQ,EAAE,CAAC,EAAE,MAAM,CAAC,CAAC;aAC7C;YAAC,IAAI,CAAC,CAAC;gBACN,QAAQ,CAAC,MAAM,CAAC,MAAM,CAAC,QAAQ,EAAE,CAAC,EAAE,MAAM,CAAC,CAAC;aAC7C;YACD,KAAK,CAAC;QACR,KAAK,SAAS;YACZ,QAAQ,CAAC,MAAM,CAAC,MAAM,CAAC,QAAQ,EAAE,CAAC,CAAC,CAAC;YACpC,KAAK,CAAC;KACT;IACD,MAAM,CAAC,QAAQ,CAAC;CACjB","sourcesContent":["import { fromCollectionRef } from '../observable/fromRef';\nimport * as firebase from 'firebase/app';\nimport 'firebase/firestore';\nimport { Observable } from 'rxjs/Observable';\nimport 'rxjs/add/operator/map';\nimport 'rxjs/add/operator/filter';\nimport 'rxjs/add/operator/scan';\n\nimport { DocumentChangeAction, Action } from '../interfaces';\n\n/**\n * Return a stream of document changes on a query. These results are not in sort order but in\n * order of occurence. \n * @param query \n */\nexport function docChanges(query: firebase.firestore.Query): Observable<DocumentChangeAction[]> {\n  return fromCollectionRef(query)\n    .map(action => \n      action.payload.docChanges\n        .map(change => ({ type: change.type, payload: change })));\n}\n\n/**\n * Return a stream of document changes on a query. These results are in sort order.\n * @param query \n */\nexport function sortedChanges(query: firebase.firestore.Query, events: firebase.firestore.DocumentChangeType[]): Observable<DocumentChangeAction[]> {\n  return fromCollectionRef(query)\n    .map(changes => changes.payload.docChanges)\n    .scan((current, changes) => combineChanges(current, changes, events), [])\n    .map(changes => changes.map(c => ({ type: c.type, payload: c })));\n}\n\n/**\n * Combines the total result set from the current set of changes from an incoming set\n * of changes.\n * @param current \n * @param changes \n * @param events\n */\nexport function combineChanges(current: firebase.firestore.DocumentChange[], changes: firebase.firestore.DocumentChange[], events: firebase.firestore.DocumentChangeType[]) {\n  changes.forEach(change => {\n    // skip unwanted change types\n    if(events.indexOf(change.type) > -1) {\n      current = combineChange(current, change);\n    }\n  });\n  return current;\n}\n\n/**\n * Creates a new sorted array from a new change.\n * @param combined \n * @param change \n */\nexport function combineChange(combined: firebase.firestore.DocumentChange[], change: firebase.firestore.DocumentChange): firebase.firestore.DocumentChange[] {\n  switch(change.type) {\n    case 'added':\n      if (combined[change.newIndex] && combined[change.newIndex].doc.id == change.doc.id) {\n        // Not sure why the duplicates are getting fired\n      } else {\n        combined.splice(change.newIndex, 0, change);\n      }\n      break;\n    case 'modified':\n      // When an item changes position we first remove it\n      // and then add it's new position\n      if(change.oldIndex !== change.newIndex) {\n        combined.splice(change.oldIndex, 1);\n        combined.splice(change.newIndex, 0, change);\n      } else {\n        combined.splice(change.newIndex, 1, change);\n      }\n      break;\n    case 'removed':\n      combined.splice(change.oldIndex, 1);\n      break;\n  }\n  return combined;\n}\n"]}